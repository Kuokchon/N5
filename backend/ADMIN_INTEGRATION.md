# 管理員系統與用戶系統整合文檔

本文檔記錄了管理員系統與用戶系統的整合過程、修復的問題以及相關實現細節。

## 目標與實現

主要目標是將 `ADMIN_USERS` 表與 `USERS` 表進行整合，使得普通用戶可以被提升為管理員，管理員也可以使用普通用戶的登錄方式訪問後台系統。

### 整合方式

1. **用戶表擴展**：
   - 在 `USERS` 表中添加 `is_admin`、`admin_role` 和 `admin_created_at` 字段
   - `is_admin` 標記用戶是否具有管理員權限
   - `admin_role` 指定管理員角色類型（super_admin、operation、developer）
   - `admin_created_at` 記錄用戶成為管理員的時間

2. **數據同步**：
   - 將原有 `ADMIN_USERS` 表中的管理員信息同步到 `USERS` 表
   - 保留 `ADMIN_USERS` 表作為遺留支持，但主要操作通過 `USERS` 表進行

## 模型層修改

### admin_model.js

admin_model.js 文件進行了徹底重寫，主要更改包括：

1. **數據源變更**：
   - 所有查詢從 `USERS` 表獲取管理員信息（而非 `ADMIN_USERS` 表）
   - 使用 `is_admin = TRUE` 條件篩選管理員用戶

2. **數據庫連接更新**：
   - 將原來的 `db` 變量替換為 `pool`，確保使用連接池提高性能和穩定性
   - 修復了連接不一致導致的 500 錯誤問題

3. **身份驗證增強**：
   - 增強了 `verify_admin_credentials` 函數，支持更多登錄方式（用戶名、郵箱、手機號）
   - 添加了詳細的日誌記錄，幫助診斷認證問題
   - 使用 bcrypt 進行密碼驗證，確保安全性

4. **功能擴展**：
   - 添加了 `promote_user_to_admin` 函數，支持將普通用戶提升為管理員
   - 添加了 `is_admin` 函數，檢查用戶是否具有管理員權限
   - 完善了 `has_permission` 函數，根據角色進行權限驗證

### operation_log_model.js

1. **數據庫連接更新**：
   - 將 `db` 變量替換為 `pool`，與 admin_model.js 保持一致
   - 修復了記錄操作日誌時可能出現的連接錯誤

## API 路由修改

### adminRoutes.js

1. **錯誤處理增強**：
   - 添加了詳細的錯誤記錄和處理邏輯
   - 增加了對常見錯誤場景的明確錯誤消息
   - 在響應中添加了更多診斷信息（如 `details` 字段）

2. **鑑權邏輯調整**：
   - 支持從 `USERS` 表驗證管理員身份
   - 處理普通用戶提升為管理員的場景

## 中間件修改

### authMiddleware.js

1. **管理員驗證增強**：
   - 修改 `authenticateAdmin` 中間件，支持兩種令牌類型：
     - `type=admin` 的管理員令牌
     - `type=user` 的普通用戶令牌（如果用戶具有管理員權限）
   - 實現無縫切換，允許普通用戶和管理員使用相同的認證系統

## 前端整合

### Login.vue

1. **登錄邏輯擴展**：
   - 支持管理員和普通用戶的雙重登錄嘗試
   - 添加普通用戶管理員權限檢查
   - 提供詳細的錯誤處理和用戶反饋

### adminStore

1. **權限管理增強**：
   - 添加 `hasPermission` 函數，進行前端權限檢查
   - 實現計算屬性，包括 `isAdmin`、`username` 和 `adminRole`

## 測試與診斷

為了確保系統穩定性和可靠性，我們添加了多個測試腳本：

1. **direct_test.js**：直接測試模型函數，繞過 API
2. **test_admin_verify_api.js**：測試管理員 API 接口功能
3. **test_admin_verify.js**：測試管理員驗證功能

這些測試確保了：
- 數據庫連接正常工作
- 管理員驗證邏輯正確執行
- API 端點正確響應請求

## 潛在問題與解決方案

1. **500 內部服務器錯誤**：
   - 問題：使用 `db` 變量而非 `pool` 連接池
   - 解決方案：統一使用 `pool` 進行數據庫操作

2. **未找到管理員用戶**：
   - 問題：數據同步不完整，管理員信息未正確同步到用戶表
   - 解決方案：執行 SQL 腳本確保數據一致性

3. **密碼驗證失敗**：
   - 問題：bcrypt 哈希生成方式不一致
   - 解決方案：使用 `reset_admin_password.js` 腳本重置密碼

## 結論與建議

1. **基礎設施建議**：
   - 使用連接池進行數據庫操作
   - 添加詳細的日誌記錄，幫助診斷問題
   - 統一錯誤處理邏輯，提供清晰的錯誤信息

2. **安全建議**：
   - 定期審核管理員權限
   - 監控管理員操作日誌
   - 實施最小權限原則

3. **未來擴展方向**：
   - 實現更細粒度的權限控制
   - 添加雙因素認證（2FA）
   - 完善審計日誌系統 